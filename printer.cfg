#####################################################################
# INCLUDE CONFIG FILES
#####################################################################
[include mainsail.cfg]
#[include timelapse.cfg]
[include ./Hardware/*.cfg]
[include ./Klipper_Macros/*.cfg]
[include ./LED/*.cfg]
[include mmu/base/*.cfg]
[include mmu/addons/*.cfg]
[include mmu/optional/*.cfg]


#####################################################################
# DUPLICATE PIN OVERRIDE
#####################################################################
[duplicate_pin_override]
pins: PF6, PF5, EBBCan:PA2

#####################################################################
# MAINSAIL.CFG CLIENT VARIABLES
#####################################################################

[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos   : False ; use custom park coordinates for x,y [True/False]
#variable_custom_park_x    : 0.0   ; custom x position; value must be within your defined min and max of X
#variable_custom_park_y    : 0.0   ; custom y position; value must be within your defined min and max of Y
#variable_custom_park_dz   : 2.0   ; custom dz value; the value in mm to lift the nozzle when move to park position
variable_retract          : 1.0   ; the value to retract while PAUSE
variable_cancel_retract   : 5.0   ; the value to retract while CANCEL_PRINT
variable_speed_retract    : 35.0  ; retract speed in mm/s
variable_unretract        : 1.0   ; the value to unretract while RESUME
variable_speed_unretract  : 35.0  ; unretract speed in mm/s
variable_speed_hop        : 15.0  ; z move speed in mm/s
variable_speed_move       : 100.0 ; move speed in mm/s
variable_park_at_cancel   : False ; allow to move the toolhead to park while execute CANCEL_PRINT [True/False]
#variable_park_at_cancel_x : 55.0  ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
#variable_park_at_cancel_y : 358.0 ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
# !!! Caution [firmware_retraction] must be defined in the printer.cfg if you set use_fw_retract: True !!!
variable_use_fw_retract   : False ; use fw_retraction instead of the manual version [True/False]
variable_idle_timeout     : 0     ; time in sec until idle_timeout kicks in. Value 0 means that no value will be set or restored
variable_runout_sensor    : ""    ; If a sensor is defined, it will be used to cancel the execution of RESUME in case no filament is detected.
#                                   Specify the config name of the runout sensor e.g "filament_switch_sensor runout". Hint use the same as in your printer.cfg
# !!! Custom macros, please use with care and review the section of the corresponding macro.
# These macros are for simple operations like setting a status LED. Please make sure your macro does not interfere with the basic macro functions.
# Only  single line commands are supported, please create a macro if you need more than one command.
variable_user_pause_macro : ""    ; Everything inside the "" will be executed after the klipper base pause (PAUSE_BASE) function
variable_user_resume_macro: ""    ; Everything inside the "" will be executed before the klipper base resume (RESUME_BASE) function
variable_user_cancel_macro: ""    ; Everything inside the "" will be executed before the klipper base cancel (CANCEL_PRINT_BASE) function
gcode:

#####################################################################
# PRINTER
#####################################################################
[printer]
kinematics: corexy
max_velocity: 500
max_accel: 10000            #Max 4000
max_z_velocity: 25         #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 2000
square_corner_velocity: 5.0
minimum_cruise_ratio: 0.5


#####################################################################
# VIRTUAL SD CARD
#####################################################################
[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT


#####################################################################
# VARIABLES
#####################################################################
#   Required - provide a filename that would be used to save the
#   variables to disk e.g. ~/printer_data/config/saved_variables.cfg

[save_variables]
filename: ~/printer_data/config/saved_variables.cfg
#filename: ~/printer_data/config/mmu/mmu_vars.cfg


#####################################################################
# EXCLUDE OBJECTS
#####################################################################
# The [exclude_object] module allows Klipper to exclude objects
# while a print is in progress. 

[exclude_object]

[gcode_macro EXCLUDE_OBJECTS]
gcode:
  {% set OBJECT = params.OBJECT|default() %}
  EXCLUDE_OBJECT NAME="{OBJECT}"

  
#####################################################################
# ARC SUPPORT
#####################################################################
# Enable arcs support
[gcode_arcs]
resolution: 0.1


#####################################################################
# IDLE TIMEOUT
#####################################################################
[idle_timeout]
timeout: 1800
gcode:
  {% if printer.pause_resume.is_paused %}
    {action_respond_info("Extruder powered down on idle timeout.")}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_extruder_temp VALUE="{printer[printer.toolhead.extruder].target}"
    M104; Turn off extruder but leave the bed on.
  {% else %}
    TURN_OFF_HEATERS
    M107; turn off fan
  {% endif %}


#####################################################################
# PAUSE
#####################################################################

[pause_resume]
recover_velocity: 50

#####################################################################
# RESPOND
#####################################################################
[respond]
default_type: echo
#default_type: command
#default_type: error


#####################################################################
# DISPLAY STATUS
#####################################################################

[display_status]


#####################################################################
# FORCE MOVE
#####################################################################
[force_move]
enable_force_move: True
#   Set to true to enable FORCE_MOVE and SET_KINEMATIC_POSITION
#   extended G-Code commands. The default is False.

[gcode_macro UNSAFE_MOVE_Z_UP]
description: ยก!--CAUTION--ยก! Move the Z axis up (away from bed) without homing. Setup for v2.4
gcode:
    {% set up = params.UP|default(10)|float %}
    G91
	SET_KINEMATIC_POSITION Z=-{up}

[gcode_macro UNSAFE_MOVE_Z_DOWN]
description: ยก!--CAUTION--ยก! Move the Z axis down (toward the bed) without homing. Setup for v2.4
gcode:
    {% set down = params.DOWN|default(10)|float %}
    G91
    SET_KINEMATIC_POSITION Z={down}
    
[gcode_macro LOAD_FILAMENT_INTO_EXTRUDER_GEARS]
gcode:
  FORCE_MOVE STEPPER=extruder DISTANCE=25 VELOCITY=50 ACCEL=300

  
#####################################################################
# HOME AXIS AT STARTUP
#####################################################################
# [gcode_macro START_HOMEING]
# description: Use with a delayed gcode or change this macro to 
# gcode:
#   SET_DISPLAY_TEXT MSG="Homing"
#   STATUS_HOMING
#   G28
#   STATUS_READY

  
#####################################################################
# SAFE Z HOME
#####################################################################
[safe_z_home]
home_xy_position: 175.5, 172
speed: 150
z_hop: 10
z_hop_speed: 20
move_to_previous: false


#####################################################################
# QGL
#####################################################################
[quad_gantry_level]

gantry_corners:
   -60, -10      #-50.201, -8.465  voron config for 350
   410, 420      #406.199, 430.366 
   
points:
   20,1
   20,316
   330,316
   330,1

speed: 160
horizontal_move_z: 2
retries: 10
retry_tolerance: 0.0075
max_adjust: 10

  
#####################################################################
# BED MESH PARAMETERS
#####################################################################
[bed_mesh]
speed: 200
horizontal_move_z: 2
mesh_min: 20, 24
mesh_max: 330,335
probe_count: 20,20
mesh_pps: 0,0
algorithm: bicubic
bicubic_tension: 0.2
adaptive_margin: 0
zero_reference_position: 175.5, 172


#####################################################################
# SKEW CORRECTION
#####################################################################
[skew_correction]

[skew_correction default_skew_profile]
xy_skew = 0.0
xz_skew = 0.0
yz_skew = 0.0

[gcode_macro SET_SKEW_PROFILE]
description: 
gcode:
  {% set SET = params.SKEW_SET|default(default_skew_profile) %}
  SET_SKEW XY="{SET}"

[gcode_macro SAVE_SKEW_PROFILE]
description: 
gcode:
  {% set SAVE = params.SKEW_SAVE|default(default_skew_profile) %}
  SKEW_PROFILE SAVE="{SAVE}"

[gcode_macro LOAD_SKEW_PROFILE]
description: 
gcode:
  {% set LOAD = params.SKEW_LOAD|default(default_skew_profile) %}
  SKEW_PROFILE LOAD="{LOAD}"

[gcode_macro REMOVE_SKEW_PROFILE]
description: 
gcode:
  {% set REMOVE = params.SKEW_REMOVE|default(default_skew_profile) %}
  SKEW_PROFILE REMOVE="{REMOVE}"

# [axis_twist_compensation]
# speed: 75               #   Speed of non homing moves  The default is 50.
# horizontal_move_z: 5
# calibrate_start_x: 22   #   Defines the minimum X coordinate for calibration
# calibrate_end_x: 338    #   Defines the maximum X coordinate.
# calibrate_y: 177.5      #   Defines the Y coordinate for calibration, recommended to be near the center of the bed.
# calibrate_start_y: 1    #   Defines the minimum Y coordinate for calibration
# calibrate_end_y: 310    #   Defines the maximum Y coordinate.
# calibrate_x: 177.5      #   Defines the X coordinate for calibration, recommended to be near the center of the bed.

# [gcode_macro AXIS_TWIST_COMPENSATION]
# description:
# gcode:

#   {% set AXIS = params.AXIS|default(X) %}
#   {% set COUNT = params.SAMPLE_COUNT|default(3) %}
#   {% if AXIS != Y %}
#     AXIS_TWIST_COMPENSATION_CALIBRATE SAMPLE_COUNT={COUNT}
#   {% else %}
#     AXIS_TWIST_COMPENSATION_CALIBRATE AXIS=Y SAMPLE_COUNT={COUNT}
#   {% endif %}


#####################################################################
# HEATER_BED
#####################################################################
[heater_bed]
#control = pid
#pid_kp = 43.328
#pid_ki = 1.992
#pid_kd = 235.597


#####################################################################
# EXTRUDER
#####################################################################
[extruder]
#control = pid
#pid_kp = 33.176
#pid_ki = 3.626
#pid_kd = 75.890
max_extrude_only_distance: 1000
max_extrude_cross_section: 50
max_extrude_only_velocity: 500
max_extrude_only_accel: 5000
instantaneous_corner_velocity: 1.0
pressure_advance: 0.028
pressure_advance_smooth_time: 0.04

[firmware_retraction_zhop]
retract_length: 1.2
retract_speed: 30
unretract_speed: 30
unretract_extra_length: 0.0
z_hop_height: 0.4
clear_zhop_on_z_moves: false

#####################################################################
# INPUT SHAPER
#####################################################################
[input_shaper]
#shaper_type_x = mzv
#shaper_freq_x = 54.4
#shaper_type_y = mzv
#shaper_freq_y = 38.4
#shaper_type_z = mzv
#shaper_freq_z = 58.2
damping_ratio_x: 0.1
damping_ratio_y: 0.1
damping_ratio_z: 0.1

[resonance_tester]
probe_points: 175, 175, 20
accel_chip: adxl345 cartographer
#accel_chip_x:
#accel_chip_y:
accel_chip_z: adxl345 cartographer
#max_smoothing: 0
min_freq: 5
max_freq: 135
accel_per_hz: 60
hz_per_sec: 1
move_speed: 100
sweeping_accel: 400
sweeping_period: 1.2
sweeping_accel_z: 50
max_freq_z: 100
accel_per_hz_z: 15



#####################################################################
# CARTOGRAPHER PROBE
#####################################################################
[cartographer]
#z_backlash: 0.00648
#z_offset: -0.435

#####################################################################
# SAVE CONFIG
#####################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 64.0
#*# shaper_type_y = mzv
#*# shaper_freq_y = 47.2
#*# shaper_type_z = 2hump_ei
#*# shaper_freq_z = 95.4
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 41.229
#*# pid_ki = 1.909
#*# pid_kd = 222.637
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.278
#*# pid_ki = 3.022
#*# pid_kd = 80.936
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.5549623293026855,2.0389964416380955,0.8309156490350962,0.309882841301964,0.42078319084991556,0.6726232693628369,-0.3197941262322243,-0.7474569045497784,0.31213081965686323,0.4260225930828305
#*# domain = 3.3019570756814187e-07,3.3734910736297223e-07
#*# z_offset = -0.1
#*# reference_temperature = 29.93
#*# software_version = 1.4.0
#*# mcu_version = CARTOGRAPHER 5.1.0
#*#
#*# [cartographer touch_model default]
#*# threshold = 1045
#*# speed = 2.0
#*# z_offset = -0.15
#*# software_version = 1.4.0
#*# mcu_version = CARTOGRAPHER 5.1.0
#*#
#*# [cartographer]
#*# z_backlash = 0.01551
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.053051, 0.011154, 0.053127, 0.082008, 0.118753, 0.130999, 0.155062, 0.163095, 0.151001, 0.147013, 0.130822, 0.116823, 0.044650, 0.006844, -0.044457
#*# 	-0.096667, -0.035684, 0.015347, 0.036246, 0.082008, 0.102383, 0.130822, 0.147013, 0.139018, 0.130822, 0.114715, 0.090181, 0.032078, -0.010143, -0.061674
#*# 	-0.123265, -0.055207, -0.022882, 0.027999, 0.048894, 0.094258, 0.122785, 0.126899, 0.126811, 0.110670, 0.118753, 0.073819, 0.023730, -0.014181, -0.066000
#*# 	-0.163562, -0.105424, -0.066000, -0.020857, 0.009050, 0.053036, 0.077921, 0.094258, 0.102383, 0.102383, 0.098507, 0.077921, 0.040591, -0.009938, -0.057364
#*# 	-0.172787, -0.110043, -0.061674, -0.027249, 0.002536, 0.040400, 0.065508, 0.090181, 0.082008, 0.086098, 0.094437, 0.069710, 0.040591, 0.002536, -0.048746
#*# 	-0.227590, -0.174919, -0.114440, -0.087821, -0.048746, -0.031510, 0.004736, 0.023730, 0.027903, 0.032078, 0.023730, -0.001585, -0.027146, -0.053051, -0.105645
#*# 	-0.236788, -0.186323, -0.141002, -0.101042, -0.074874, -0.048746, -0.022882, 0.002730, 0.011154, 0.019542, -0.001483, -0.027146, -0.048746, -0.066105, -0.109822
#*# 	-0.227590, -0.181797, -0.141002, -0.105534, -0.079222, -0.057364, -0.027146, -0.001687, 0.006945, 0.019542, -0.003699, -0.027146, -0.044457, -0.066000, -0.105534
#*# 	-0.227590, -0.195380, -0.150027, -0.114440, -0.083568, -0.057364, -0.029276, -0.014385, 0.002536, 0.006945, -0.010143, -0.040166, -0.048746, -0.074770, -0.114218
#*# 	-0.186323, -0.147799, -0.101042, -0.063941, -0.031613, -0.014385, 0.006945, 0.011154, 0.027999, 0.040495, 0.040591, 0.006945, -0.003699, -0.039959, -0.083568
#*# 	-0.150140, -0.110043, -0.070543, -0.031613, -0.005916, 0.015347, 0.032078, 0.040495, 0.053036, 0.048894, 0.044746, 0.032078, 0.015347, -0.022882, -0.066000
#*# 	-0.134335, -0.096773, -0.061882, -0.031510, 0.002536, 0.019542, 0.040591, 0.057258, 0.053036, 0.048894, 0.048894, 0.036246, 0.015347, -0.014385, -0.053051
#*# 	-0.096667, -0.070324, -0.035890, -0.005814, 0.023730, 0.044555, 0.061481, 0.082008, 0.073819, 0.073819, 0.069710, 0.048894, 0.032271, 0.006945, -0.031407
#*# 	-0.057364, -0.022882, 0.002633, 0.027903, 0.057163, 0.073724, 0.092309, 0.106619, 0.102383, 0.096382, 0.086098, 0.069529, 0.050965, 0.019542, -0.018626
#*# 	-0.035684, -0.001483, 0.023730, 0.044746, 0.061481, 0.077921, 0.098507, 0.114715, 0.102571, 0.098417, 0.086098, 0.073819, 0.044746, 0.011154, -0.031407
#*# min_x = 20.0
#*# min_y = 24.0
#*# max_x = 330.0
#*# max_y = 335.0
#*# x_count = 15
#*# y_count = 15
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*#
#*# [bed_mesh ADAPTIVE_SLICER_PRINT]
#*# version = 1
#*# points =
#*# 	-0.040843, -0.028780, -0.021080, -0.014215, -0.004420, 0.007456, 0.017020, 0.028969, 0.037335, 0.038532, 0.047996, 0.047988, 0.046642, 0.045684, 0.045635, 0.050493, 0.055057, 0.055009, 0.045573, 0.034756
#*# 	-0.055983, -0.046086, -0.033775, -0.028902, -0.019099, -0.004669, 0.007474, 0.012013, 0.020377, 0.026491, 0.031214, 0.033410, 0.031151, 0.035928, 0.038402, 0.040592, 0.040717, 0.041923, 0.036147, 0.024310
#*# 	-0.063462, -0.051032, -0.041302, -0.031527, -0.024166, -0.012200, -0.002552, 0.009436, 0.019111, 0.022669, 0.026210, 0.028447, 0.028429, 0.031155, 0.030988, 0.035726, 0.040672, 0.038104, 0.030853, 0.019301
#*# 	-0.064684, -0.053761, -0.046380, -0.040148, -0.034086, -0.017025, -0.004937, 0.002142, 0.010630, 0.018892, 0.021489, 0.021409, 0.019033, 0.026084, 0.030736, 0.030916, 0.030970, 0.030916, 0.026301, 0.016679
#*# 	-0.076209, -0.064993, -0.053747, -0.046542, -0.036673, -0.026949, -0.017179, -0.005261, 0.004476, 0.009124, 0.011656, 0.011459, 0.016400, 0.018637, 0.016483, 0.021290, 0.028320, 0.026228, 0.020087, 0.009349
#*# 	-0.078707, -0.066192, -0.056400, -0.049057, -0.044119, -0.031643, -0.017214, -0.008620, -0.002700, 0.004558, 0.011655, 0.011807, 0.011733, 0.016465, 0.021045, 0.021354, 0.021418, 0.023659, 0.018855, 0.007108
#*# 	-0.085978, -0.071404, -0.062388, -0.055061, -0.046523, -0.036782, -0.026850, -0.011366, -0.000643, 0.006558, 0.009005, 0.009106, 0.011276, 0.013851, 0.016154, 0.019705, 0.022217, 0.023218, 0.016318, 0.006787
#*# 	-0.086267, -0.075048, -0.063880, -0.056314, -0.049057, -0.035675, -0.022247, -0.010076, -0.005604, 0.004121, 0.009120, 0.011541, 0.011432, 0.012619, 0.017487, 0.021026, 0.018793, 0.016355, 0.013911, 0.006722
#*# 	-0.096306, -0.082489, -0.078784, -0.068758, -0.056639, -0.045362, -0.034375, -0.024677, -0.012698, -0.003008, 0.000563, 0.001797, 0.004411, 0.008982, 0.009078, 0.011294, 0.013688, 0.013879, 0.009014, 0.001933
#*# 	-0.104999, -0.091272, -0.083640, -0.075077, -0.064149, -0.054165, -0.039468, -0.028539, -0.017137, -0.012637, -0.007797, -0.003032, -0.000409, -0.003045, 0.004163, 0.006769, 0.006805, 0.001932, 0.002042, -0.006450
#*# 	-0.106317, -0.091347, -0.084999, -0.076451, -0.066395, -0.056640, -0.043131, -0.032141, -0.022482, -0.010467, -0.005557, -0.004272, -0.000593, 0.001544, 0.004079, 0.005401, 0.006576, 0.008849, 0.004255, -0.002981
#*# 	-0.096391, -0.081522, -0.074003, -0.064034, -0.056725, -0.046776, -0.032361, -0.019907, -0.010458, -0.005372, -0.000797, 0.004070, 0.004052, 0.004043, 0.007776, 0.013659, 0.011505, 0.009042, 0.006694, 0.001717
#*# 	-0.080202, -0.066491, -0.061927, -0.054308, -0.044410, -0.032436, -0.024968, -0.015350, -0.003321, 0.006428, 0.008656, 0.008877, 0.012321, 0.015789, 0.018208, 0.018264, 0.018373, 0.018409, 0.016063, 0.008909
#*# 	-0.066796, -0.056841, -0.047162, -0.042033, -0.033596, -0.026224, -0.013038, -0.003208, 0.002768, 0.011267, 0.015779, 0.018035, 0.018227, 0.017149, 0.020762, 0.025485, 0.023082, 0.018441, 0.013732, 0.011322
#*# 	-0.066757, -0.052030, -0.047057, -0.042261, -0.034994, -0.022682, -0.015275, -0.006090, 0.003831, 0.013366, 0.015889, 0.015770, 0.018117, 0.020535, 0.022845, 0.020727, 0.020480, 0.020589, 0.015802, 0.008675
#*# 	-0.066893, -0.054451, -0.047067, -0.039930, -0.032530, -0.025392, -0.013234, -0.003380, 0.002568, 0.008610, 0.013403, 0.015757, 0.015851, 0.013311, 0.015954, 0.018410, 0.017141, 0.011245, 0.008803, 0.001552
#*# 	-0.062149, -0.047358, -0.043641, -0.037560, -0.027829, -0.017988, -0.010760, -0.001306, 0.006052, 0.015660, 0.015518, 0.015734, 0.015532, 0.020535, 0.020315, 0.020420, 0.020490, 0.020143, 0.016834, 0.007317
#*# 	-0.047372, -0.035183, -0.027890, -0.022980, -0.015533, -0.006164, 0.003568, 0.013229, 0.018117, 0.022813, 0.026608, 0.031115, 0.027768, 0.027668, 0.031056, 0.032241, 0.029786, 0.025167, 0.020763, 0.016999
#*# 	-0.040219, -0.025495, -0.020638, -0.018238, -0.010942, 0.001021, 0.007984, 0.015404, 0.024885, 0.029641, 0.029913, 0.032146, 0.034423, 0.034500, 0.034373, 0.034622, 0.036991, 0.034572, 0.032137, 0.022472
#*# 	-0.025378, -0.015815, -0.008588, -0.005994, 0.001095, 0.009613, 0.022713, 0.029912, 0.034491, 0.039272, 0.043864, 0.044088, 0.041839, 0.042770, 0.045091, 0.046336, 0.043909, 0.039349, 0.034730, 0.029804
#*# min_x = 96.0
#*# min_y = 95.6
#*# max_x = 258.3
#*# max_y = 282.93
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*#
#*# [cartographer coil]
#*# calibration = -7.763585784034742e-05,4.748918185829496,0.008621348478533393,-606.5590146250368
